var L=Object.defineProperty;var i=(t,a)=>L(t,"name",{value:a,configurable:!0});import{isMainThread as D}from"node:worker_threads";import{i as h,a as M,e as $,m as A}from"../node-features-_8ZFwP_x.mjs";import{r as I}from"../register-C_6Nc_P5.mjs";import"../get-pipe-path-BHW2eJdv.mjs";import"node:module";import _ from"node:path";import{fileURLToPath as E,pathToFileURL as b}from"node:url";import"get-tsconfig";import R from"node:fs";import"esbuild";import"node:crypto";import{t as k,a as W}from"../index-CEhzVOC2.mjs";import{p as T}from"../client-BQVF1NaW.mjs";import{l as U,t as w,a as v,b as j,f as C,c as N,d as O,e as Q,g as q,h as G,j as H,k as F}from"../register-CFdTi8dP.mjs";import"../require-BaX0y-S3.mjs";import{readFile as X}from"node:fs/promises";import"module";import"../temporary-directory-CwHp0_NW.mjs";import"node:os";import"node:net";const p={active:!0},B=i(async t=>{if(!t)throw new Error(`tsx must be loaded with --import instead of --loader
The --loader flag was deprecated in Node v20.6.0 and v18.19.0`);p.namespace=t.namespace,t.tsconfig!==!1&&U(t.tsconfig??process.env.TSX_TSCONFIG_PATH),t.port&&(p.port=t.port,t.port.on("message",a=>{a==="deactivate"&&(p.active=!1,t.port.postMessage({type:"deactivated"}))}))},"initialize"),K=i(()=>(U(process.env.TSX_TSCONFIG_PATH),"process.setSourceMapsEnabled(true);"),"globalPreload"),d=new Map,z=i(async t=>{if(d.has(t))return d.get(t);if(!await R.promises.access(t).then(()=>!0,()=>!1)){d.set(t,void 0);return}const o=await R.promises.readFile(t,"utf8");try{const n=JSON.parse(o);return d.set(t,n),n}catch{throw new Error(`Error parsing: ${t}`)}},"readPackageJson"),x=i(async t=>{let a=new URL("package.json",t);for(;!a.pathname.endsWith("/node_modules/package.json");){const o=E(a),n=await z(o);if(n)return n;const e=a;if(a=new URL("../package.json",a),a.pathname===e.pathname)break}},"findPackageJson"),V=i(async t=>(await x(t))?.type??"commonjs","getPackageType"),Y=i(t=>{[t]=t.split("?");const a=_.extname(t);if(a===".json")return"json";if(a===".mjs"||a===".mts")return"module";if(a===".cjs"||a===".cts")return"commonjs"},"getFormatFromExtension"),Z=i(t=>{const a=Y(t);if(a)return a;if(w.test(t))return V(t)},"getFormatFromFileUrl"),u="tsx-namespace=",g=i(t=>{const a=t.indexOf(u);if(a===-1)return;const o=t[a-1];if(o!=="?"&&o!=="&")return;const n=a+u.length,e=t.indexOf("&",n);return e===-1?t.slice(n):t.slice(n,e)},"getNamespace"),y=h(M)?"importAttributes":"importAssertions",tt=i(async(t,a,o)=>{if(!p.active)return o(t,a);const n=g(t);if(p.namespace&&p.namespace!==n)return o(t,a);if(p.port){const s=new URL(t);s.searchParams.delete("tsx-namespace"),p.port.postMessage({type:"load",url:s.toString()})}T.send&&T.send({type:"dependency",path:t}),v.test(t)&&(a[y]||(a[y]={}),a[y].type="json");const e=await o(t,a),m=t.startsWith("file://")?E(t):t;if(e.format==="commonjs"&&h($)&&e.responseURL?.startsWith("file:")&&!m.endsWith(".cjs")){const s=await k(await X(new URL(t),"utf8"),m,{format:"cjs",platform:"node"}),c=new URLSearchParams({filePath:m});return n&&c.set("namespace",n),e.responseURL=`data:text/javascript,${encodeURIComponent(s.code)}?${c.toString()}`,e}if(!e.source)return e;const r=e.source.toString();if(e.format==="json"||w.test(t)){const s=await k(r,m,{tsconfigRaw:C?.(m)});return{format:"module",source:j(s)}}if(e.format==="module"){const s=W(m,r);s&&(e.source=j(s))}return e},"load"),l=i(async t=>(!t.format&&t.url.startsWith(H)&&(t.format=await Z(t.url)),t),"resolveMissingFormat"),at=[".js",".json",".ts",".tsx",".jsx"],P=i(async(t,a,o)=>{const[n,e]=t.split("?");let m;for(const r of at)try{return await l(await o(n+r+(e?`?${e}`:""),a))}catch(s){if(m===void 0&&s instanceof Error){const{message:c}=s;s.message=s.message.replace(`${r}'`,"'"),s.stack=s.stack.replace(c,s.message),m=s}}throw m},"tryExtensions"),S=i(async(t,a,o)=>{const n=O.test(t),e=n?"index":"/index",[m,r]=t.split("?");try{return await P(m+e+(r?`?${r}`:""),a,o)}catch(s){if(!n)try{return await P(t,a,o)}catch{}const c=s,{message:f}=c;throw c.message=c.message.replace(`${e.replace("/",_.sep)}'`,"'"),c.stack=c.stack.replace(f,c.message),c}},"tryDirectory"),J=i(async(t,a,o,n)=>{if(!p.active)return o(t,a);const e=a.parentURL&&g(a.parentURL);if(N(t)){let r=g(t);if(e&&!r&&(r=e,t+=`${t.includes("?")?"&":"?"}${u}${e}`),p.namespace&&p.namespace!==r)return o(t,a);if(O.test(t))return await S(t,a,o)}else if(F&&!a.parentURL?.includes("/node_modules/")){const r=F(t);for(const s of r)try{return await J(b(s).toString(),a,o)}catch{}}if(!Q.test(t)&&(w.test(a.parentURL)||q)){const r=G(t);if(r)for(const s of r)try{return await l(await o(s,a))}catch(c){const{code:f}=c;if(f!=="ERR_MODULE_NOT_FOUND"&&f!=="ERR_PACKAGE_PATH_NOT_EXPORTED")throw c}}try{const r=await l(await o(t,a));if(N(r.url)){const s=g(r.url);e&&!s&&(r.url+=`${r.url.includes("?")?"&":"?"}${u}${e}`)}return r}catch(r){if(r instanceof Error&&!n){const{code:s}=r;if(s==="ERR_UNSUPPORTED_DIR_IMPORT")try{return await S(t,a,o)}catch(c){if(c.code!=="ERR_PACKAGE_IMPORT_NOT_DEFINED")throw c}if(s==="ERR_MODULE_NOT_FOUND")try{return await P(t,a,o)}catch{}}throw r}},"resolve");h(A)&&D&&I();export{K as globalPreload,B as initialize,tt as load,J as resolve};
